<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Analysis of two-factorial experiments with general linear (mixed effect) models – Einführung in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Einführung in R</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/01/01_Allgemeines.html"> 
<span class="menu-text">Allgemeines</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/02/02_DeskriptiveStats.html"> 
<span class="menu-text">Deskriptive Statistik</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/03/03_Graph.html"> 
<span class="menu-text">Grafische Darstellungen</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/04/04_Anova.html"> 
<span class="menu-text">ANOVA</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/05/05_Regression.html"> 
<span class="menu-text">Regression</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/06/06_StatMod.html"> 
<span class="menu-text">Statistische Modellierung</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/07/07_ExpDesign.html"> 
<span class="menu-text">Experimental Design</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../Themen/08/08_2f_LM.html" aria-current="page"> 
<span class="menu-text">Two-factorial LM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/09/09_2f_GLM.html"> 
<span class="menu-text">Two-factorial GLM</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#import-data" id="toc-import-data" class="nav-link active" data-scroll-target="#import-data">Import data</a></li>
  <li><a href="#crd" id="toc-crd" class="nav-link" data-scroll-target="#crd">CRD</a>
  <ul class="collapse">
  <li><a href="#linear-model-anova" id="toc-linear-model-anova" class="nav-link" data-scroll-target="#linear-model-anova">Linear model (Anova)</a>
  <ul class="collapse">
  <li><a href="#test-of-significance-and-posthoc-tests" id="toc-test-of-significance-and-posthoc-tests" class="nav-link" data-scroll-target="#test-of-significance-and-posthoc-tests">Test of significance and posthoc tests</a></li>
  <li><a href="#presentation-of-results" id="toc-presentation-of-results" class="nav-link" data-scroll-target="#presentation-of-results">Presentation of results</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#rcbd" id="toc-rcbd" class="nav-link" data-scroll-target="#rcbd">RCBD</a>
  <ul class="collapse">
  <li><a href="#linear-model-with-block-as-fixed-effect" id="toc-linear-model-with-block-as-fixed-effect" class="nav-link" data-scroll-target="#linear-model-with-block-as-fixed-effect">Linear model with block as fixed effect</a></li>
  <li><a href="#linear-mixed-effect-model-with-block-as-random-effect-glmmtmb" id="toc-linear-mixed-effect-model-with-block-as-random-effect-glmmtmb" class="nav-link" data-scroll-target="#linear-mixed-effect-model-with-block-as-random-effect-glmmtmb">Linear mixed effect model with block as random effect (glmmTMB)</a></li>
  <li><a href="#linear-mixed-effect-model-with-block-as-random-effect-lme4" id="toc-linear-mixed-effect-model-with-block-as-random-effect-lme4" class="nav-link" data-scroll-target="#linear-mixed-effect-model-with-block-as-random-effect-lme4">Linear mixed effect model with block as random effect (lme4)</a>
  <ul class="collapse">
  <li><a href="#lets-compare-the-models" id="toc-lets-compare-the-models" class="nav-link" data-scroll-target="#lets-compare-the-models">Let’s compare the models</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis of two-factorial experiments with general linear (mixed effect) models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)<span class="co"># plotting</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)<span class="co"># data management and summary statistics</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)<span class="co"># plotting</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx)<span class="co"># import and export Excel files</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)<span class="co"># factor repordering</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa) <span class="co"># model diagnostics</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans) <span class="co"># posthoc tests</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcomp) <span class="co"># cld</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcompView) <span class="co">#cld</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB) <span class="co"># mixed model</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car) <span class="co"># anova for glmmTMB</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) <span class="co"># lmer and glmer mixed model</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) <span class="co"># test lmer</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(lmerTest<span class="sc">::</span>lmer)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress summarise info</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Suppose we have a complete randomized design with three nitrogen fertilisation levels <code>N</code> (<code>low</code>, <code>medium</code>, <code>high</code>) and four genotypes <code>geno</code> (<code>g1</code>, <code>g2</code>, <code>g3</code> and <code>g4</code>) and five replications <code>rep</code>. For each treatment crop yield <code>yield</code> was measured.</p>
<p>The research question is: Do yields differ between genotypes and nitrogen fertilisation? In particular, do genotypes respond differently to different nitrogen fertilisation?</p>
<section id="import-data" class="level3">
<h3 class="anchored" data-anchor-id="import-data">Import data</h3>
<p><a href="https://github.com/DoreenGabriel/Kurs/blob/main/Themen/08/data_YSM.xlsx" target="_blank">data_YSM.xlsx</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">read.xlsx</span>(<span class="st">"data_YSM.xlsx"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   60 obs. of  7 variables:
 $ rep    : num  1 2 3 4 5 1 2 3 4 5 ...
 $ geno   : chr  "g1" "g1" "g1" "g1" ...
 $ N      : chr  "low" "low" "low" "low" ...
 $ yield  : num  55.9 63 69.5 59.6 64.4 ...
 $ pests  : num  3 0 8 1 4 8 4 6 4 16 ...
 $ pests.A: num  82 91 86 58 45 111 85 107 82 86 ...
 $ pests.B: num  82 91 86 58 45 111 85 107 82 86 ...</code></pre>
</div>
</div>
<p>convert <code>geno</code> and <code>N</code> to factors, levels of N should not be in alphabetical order</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(geno, N), <span class="sc">~</span> <span class="fu">as.factor</span>(.x)),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">N=</span><span class="fu">fct_relevel</span>(N, <span class="st">"low"</span>, <span class="st">"med"</span>, <span class="st">"high"</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">block=</span><span class="fu">as.factor</span>(rep))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   60 obs. of  8 variables:
 $ rep    : num  1 2 3 4 5 1 2 3 4 5 ...
 $ geno   : Factor w/ 4 levels "g1","g2","g3",..: 1 1 1 1 1 2 2 2 2 2 ...
 $ N      : Factor w/ 3 levels "low","med","high": 1 1 1 1 1 1 1 1 1 1 ...
 $ yield  : num  55.9 63 69.5 59.6 64.4 ...
 $ pests  : num  3 0 8 1 4 8 4 6 4 16 ...
 $ pests.A: num  82 91 86 58 45 111 85 107 82 86 ...
 $ pests.B: num  82 91 86 58 45 111 85 107 82 86 ...
 $ block  : Factor w/ 5 levels "1","2","3","4",..: 1 2 3 4 5 1 2 3 4 5 ...</code></pre>
</div>
</div>
<section id="plot-data" class="level4">
<h4 class="anchored" data-anchor-id="plot-data">Plot data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>geno)) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span><span class="st">"errorbar"</span>, <span class="at">width =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape=</span><span class="cn">NA</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="fl">0.1</span>, <span class="at">jitter.height =</span> <span class="dv">0</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dodge.width=</span><span class="fl">0.6</span>), <span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>geno, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span><span class="st">"errorbar"</span>, <span class="at">width =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape=</span><span class="cn">NA</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="fl">0.1</span>, <span class="at">jitter.height =</span> <span class="dv">0</span>, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dodge.width=</span><span class="fl">0.6</span>), <span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="crd" class="level1">
<h1>CRD</h1>
<section id="linear-model-anova" class="level2">
<h2 class="anchored" data-anchor-id="linear-model-anova">Linear model (Anova)</h2>
<p>We fit a linear model with <code>yield</code> as response and <code>geno</code> and <code>N</code> as explanatory variables. It is important that the dependent variable is continuous and the explanatory variables are factors. By using <code>geno * N</code>, we fit the main effect and interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(yield <span class="sc">~</span> geno <span class="sc">*</span> N, <span class="at">data =</span> df)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = yield ~ geno * N, data = df)

Residuals:
     Min       1Q   Median       3Q      Max 
-12.1180  -3.7234   0.0388   3.9731   9.9417 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   62.4910     2.5157  24.840  &lt; 2e-16 ***
genog2        -3.2606     3.5578  -0.916  0.36400    
genog3         1.4225     3.5578   0.400  0.69106    
genog4        -0.9117     3.5578  -0.256  0.79885    
Nmed           6.2378     3.5578   1.753  0.08594 .  
Nhigh         20.3527     3.5578   5.721 6.68e-07 ***
genog2:Nmed    1.1303     5.0315   0.225  0.82321    
genog3:Nmed    6.0655     5.0315   1.206  0.23392    
genog4:Nmed    2.0285     5.0315   0.403  0.68862    
genog2:Nhigh  10.9283     5.0315   2.172  0.03483 *  
genog3:Nhigh  -3.7315     5.0315  -0.742  0.46193    
genog4:Nhigh  14.9123     5.0315   2.964  0.00472 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.625 on 48 degrees of freedom
Multiple R-squared:  0.8421,    Adjusted R-squared:  0.8059 
F-statistic: 23.28 on 11 and 48 DF,  p-value: 1.381e-15</code></pre>
</div>
</div>
<p>Before interpreting the model, we perform model diagnostics by plotting residuals against fitted values and explanatory variables.</p>
<p>We visually check the assumptions of the ANOVA for</p>
<ul>
<li>approximate normal distribution of errors (i.e.&nbsp;residuals)</li>
<li>homogeneity of variance</li>
</ul>
<p>I use the <code>library(DHARMa)</code> for this. <a href="https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html" target="_blank">https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model, <span class="at">plot =</span> F)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>The first graph shows a QQ plot of the standardised <code>residuals</code>, which provides us with information about the <strong>normal distribution of the residuals</strong>. If the points lie approximately along the bisector (red line), this indicates that the residuals are approximately normally distributed. We are also shown p-values for the KS test (Kolmogorov-Smirnov test for normal distribution), a dispersion test and an outlier test.</p></li>
<li><p>The second graph plots the ‘residuals’ against the ‘fitted values’. We want to see here that the dispersion around 0.5 is approximately the same for both high and low values (<strong>variance homogeneity</strong>). The plot is also helpful for identifying peculiar samples. These are shown as red asterisks (but do not necessarily have to be labelled as outliers).</p></li>
<li><p>To check the variance homogeneity between the groups, we should plot the residuals against the explanatory variables.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As long as all tests are not significant (and no red lines or boxes are displayed), everything is (more or less) fine. BUT it should be noted that the power of the tests depends on the number of observations. The more observations we have, the higher the power of the test. This means that significant differences, e.g.&nbsp;in the variances, are often observed with a large sample size, although these are practically irrelevant. In addition, significant differences are often not observed with a small sample size, although there are significant differences.</p>
<p>The <em>visual</em> model diagnostics are therefore often regarded as more important than the p-value-based tests for normal distribution and variance homogeneity (Cochran, Bartlett and Levenes test).</p>
<section id="test-of-significance-and-posthoc-tests" class="level3">
<h3 class="anchored" data-anchor-id="test-of-significance-and-posthoc-tests">Test of significance and posthoc tests</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Response: yield
          Df Sum Sq Mean Sq  F value    Pr(&gt;F)    
geno       3  195.6    65.2   2.0602 0.1179439    
N          2 6955.4  3477.7 109.8981 &lt; 2.2e-16 ***
geno:N     6  951.5   158.6   5.0114 0.0004664 ***
Residuals 48 1518.9    31.6                       
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>We have a significant interaction between genotype and nitrogen fertilisation, but we do not know which treatments differ from each other and we also do not know anything about the effect sizes, e.g.&nbsp;the difference in yield between low and medium nitrogen fertilisation for geno g1.</p>
<p>The <code>library(emmeans)</code> with the function <code>emmeans()</code> offers a variety of possibilities to perform a posthoc test on the fitted model and calculate confidence intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model, <span class="sc">~</span>geno<span class="sc">*</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> geno N    emmean   SE df lower.CL upper.CL
 g1   low    62.5 2.52 48     57.4     67.5
 g2   low    59.2 2.52 48     54.2     64.3
 g3   low    63.9 2.52 48     58.9     69.0
 g4   low    61.6 2.52 48     56.5     66.6
 g1   med    68.7 2.52 48     63.7     73.8
 g2   med    66.6 2.52 48     61.5     71.7
 g3   med    76.2 2.52 48     71.2     81.3
 g4   med    69.8 2.52 48     64.8     74.9
 g1   high   82.8 2.52 48     77.8     87.9
 g2   high   90.5 2.52 48     85.5     95.6
 g3   high   80.5 2.52 48     75.5     85.6
 g4   high   96.8 2.52 48     91.8    101.9

Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>With the argument <code>method=‘pairwise’</code> you can compare all treatments with each other using Tukey test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>geno<span class="sc">*</span>N), <span class="at">method=</span><span class="st">"pairwise"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> contrast          estimate   SE df t.ratio p.value
 g1 low - g2 low      3.261 3.56 48   0.916  0.9986
 g1 low - g3 low     -1.423 3.56 48  -0.400  1.0000
 g1 low - g4 low      0.912 3.56 48   0.256  1.0000
 g1 low - g1 med     -6.238 3.56 48  -1.753  0.8340
 g1 low - g2 med     -4.107 3.56 48  -1.155  0.9900
 g1 low - g3 med    -13.726 3.56 48  -3.858  0.0159
 g1 low - g4 med     -7.355 3.56 48  -2.067  0.6470
 g1 low - g1 high   -20.353 3.56 48  -5.721  &lt;.0001
 g1 low - g2 high   -28.020 3.56 48  -7.876  &lt;.0001
 g1 low - g3 high   -18.044 3.56 48  -5.072  0.0004
 g1 low - g4 high   -34.353 3.56 48  -9.656  &lt;.0001
 g2 low - g3 low     -4.683 3.56 48  -1.316  0.9728
 g2 low - g4 low     -2.349 3.56 48  -0.660  0.9999
 g2 low - g1 med     -9.498 3.56 48  -2.670  0.2722
 g2 low - g2 med     -7.368 3.56 48  -2.071  0.6445
 g2 low - g3 med    -16.986 3.56 48  -4.774  0.0010
 g2 low - g4 med    -10.615 3.56 48  -2.984  0.1454
 g2 low - g1 high   -23.613 3.56 48  -6.637  &lt;.0001
 g2 low - g2 high   -31.281 3.56 48  -8.792  &lt;.0001
 g2 low - g3 high   -21.304 3.56 48  -5.988  &lt;.0001
 g2 low - g4 high   -37.614 3.56 48 -10.572  &lt;.0001
 g3 low - g4 low      2.334 3.56 48   0.656  0.9999
 g3 low - g1 med     -4.815 3.56 48  -1.353  0.9668
 g3 low - g2 med     -2.685 3.56 48  -0.755  0.9998
 g3 low - g3 med    -12.303 3.56 48  -3.458  0.0470
 g3 low - g4 med     -5.932 3.56 48  -1.667  0.8738
 g3 low - g1 high   -18.930 3.56 48  -5.321  0.0002
 g3 low - g2 high   -26.598 3.56 48  -7.476  &lt;.0001
 g3 low - g3 high   -16.621 3.56 48  -4.672  0.0013
 g3 low - g4 high   -32.931 3.56 48  -9.256  &lt;.0001
 g4 low - g1 med     -7.150 3.56 48  -2.010  0.6849
 g4 low - g2 med     -5.019 3.56 48  -1.411  0.9557
 g4 low - g3 med    -14.638 3.56 48  -4.114  0.0075
 g4 low - g4 med     -8.266 3.56 48  -2.323  0.4750
 g4 low - g1 high   -21.264 3.56 48  -5.977  &lt;.0001
 g4 low - g2 high   -28.932 3.56 48  -8.132  &lt;.0001
 g4 low - g3 high   -18.955 3.56 48  -5.328  0.0002
 g4 low - g4 high   -35.265 3.56 48  -9.912  &lt;.0001
 g1 med - g2 med      2.130 3.56 48   0.599  1.0000
 g1 med - g3 med     -7.488 3.56 48  -2.105  0.6220
 g1 med - g4 med     -1.117 3.56 48  -0.314  1.0000
 g1 med - g1 high   -14.115 3.56 48  -3.967  0.0116
 g1 med - g2 high   -21.783 3.56 48  -6.122  &lt;.0001
 g1 med - g3 high   -11.806 3.56 48  -3.318  0.0668
 g1 med - g4 high   -28.115 3.56 48  -7.902  &lt;.0001
 g2 med - g3 med     -9.618 3.56 48  -2.703  0.2558
 g2 med - g4 med     -3.247 3.56 48  -0.913  0.9987
 g2 med - g1 high   -16.245 3.56 48  -4.566  0.0019
 g2 med - g2 high   -23.913 3.56 48  -6.721  &lt;.0001
 g2 med - g3 high   -13.936 3.56 48  -3.917  0.0134
 g2 med - g4 high   -30.246 3.56 48  -8.501  &lt;.0001
 g3 med - g4 med      6.371 3.56 48   1.791  0.8148
 g3 med - g1 high    -6.627 3.56 48  -1.863  0.7752
 g3 med - g2 high   -14.295 3.56 48  -4.018  0.0100
 g3 med - g3 high    -4.318 3.56 48  -1.214  0.9852
 g3 med - g4 high   -20.627 3.56 48  -5.798  &lt;.0001
 g4 med - g1 high   -12.998 3.56 48  -3.653  0.0280
 g4 med - g2 high   -20.666 3.56 48  -5.809  &lt;.0001
 g4 med - g3 high   -10.689 3.56 48  -3.004  0.1389
 g4 med - g4 high   -26.999 3.56 48  -7.589  &lt;.0001
 g1 high - g2 high   -7.668 3.56 48  -2.155  0.5879
 g1 high - g3 high    2.309 3.56 48   0.649  0.9999
 g1 high - g4 high  -14.001 3.56 48  -3.935  0.0127
 g2 high - g3 high    9.977 3.56 48   2.804  0.2108
 g2 high - g4 high   -6.333 3.56 48  -1.780  0.8204
 g3 high - g4 high  -16.310 3.56 48  -4.584  0.0018

P value adjustment: tukey method for comparing a family of 12 estimates </code></pre>
</div>
</div>
<p>However, these are quite a few comparisons and we may not want to compare all possible combinations, but rather be interested in how each genotype responds in yield to increasing nitrogen fertilisation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">infer=</span><span class="fu">c</span>(T,T)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 contrast   estimate   SE df lower.CL upper.CL t.ratio p.value
 low - med     -6.24 3.56 48    -14.8    2.367  -1.753  0.1963
 low - high   -20.35 3.56 48    -29.0  -11.748  -5.721  &lt;.0001
 med - high   -14.11 3.56 48    -22.7   -5.510  -3.967  0.0007

geno = g2:
 contrast   estimate   SE df lower.CL upper.CL t.ratio p.value
 low - med     -7.37 3.56 48    -16.0    1.236  -2.071  0.1067
 low - high   -31.28 3.56 48    -39.9  -22.676  -8.792  &lt;.0001
 med - high   -23.91 3.56 48    -32.5  -15.308  -6.721  &lt;.0001

geno = g3:
 contrast   estimate   SE df lower.CL upper.CL t.ratio p.value
 low - med    -12.30 3.56 48    -20.9   -3.699  -3.458  0.0032
 low - high   -16.62 3.56 48    -25.2   -8.017  -4.672  0.0001
 med - high    -4.32 3.56 48    -12.9    4.287  -1.214  0.4510

geno = g4:
 contrast   estimate   SE df lower.CL upper.CL t.ratio p.value
 low - med     -8.27 3.56 48    -16.9    0.338  -2.323  0.0621
 low - high   -35.26 3.56 48    -43.9  -26.660  -9.912  &lt;.0001
 med - high   -27.00 3.56 48    -35.6  -18.394  -7.589  &lt;.0001

Confidence level used: 0.95 
Conf-level adjustment: tukey method for comparing a family of 3 estimates 
P value adjustment: tukey method for comparing a family of 3 estimates </code></pre>
</div>
</div>
<p>Here we see the difference between the treatment levels for each genotype (<code>estimate</code>), the confidence interval of the difference (if it does not include the 0 we usually have significant differences) and the <code>p.value</code>.</p>
<p>The <code>emmean</code> is the predicted value for each treatment level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N    emmean   SE df lower.CL upper.CL
 low    62.5 2.52 48     57.4     67.5
 med    68.7 2.52 48     63.7     73.8
 high   82.8 2.52 48     77.8     87.9

geno = g2:
 N    emmean   SE df lower.CL upper.CL
 low    59.2 2.52 48     54.2     64.3
 med    66.6 2.52 48     61.5     71.7
 high   90.5 2.52 48     85.5     95.6

geno = g3:
 N    emmean   SE df lower.CL upper.CL
 low    63.9 2.52 48     58.9     69.0
 med    76.2 2.52 48     71.2     81.3
 high   80.5 2.52 48     75.5     85.6

geno = g4:
 N    emmean   SE df lower.CL upper.CL
 low    61.6 2.52 48     56.5     66.6
 med    69.8 2.52 48     64.8     74.9
 high   96.8 2.52 48     91.8    101.9

Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>We can also swap the interpretation code to obtain pairwise differences for the genotypes for each nitrogen level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>geno<span class="sc">|</span>N), <span class="at">method=</span><span class="st">"pairwise"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>N = low:
 contrast estimate   SE df t.ratio p.value
 g1 - g2     3.261 3.56 48   0.916  0.7962
 g1 - g3    -1.423 3.56 48  -0.400  0.9781
 g1 - g4     0.912 3.56 48   0.256  0.9940
 g2 - g3    -4.683 3.56 48  -1.316  0.5573
 g2 - g4    -2.349 3.56 48  -0.660  0.9114
 g3 - g4     2.334 3.56 48   0.656  0.9129

N = med:
 contrast estimate   SE df t.ratio p.value
 g1 - g2     2.130 3.56 48   0.599  0.9319
 g1 - g3    -7.488 3.56 48  -2.105  0.1662
 g1 - g4    -1.117 3.56 48  -0.314  0.9891
 g2 - g3    -9.618 3.56 48  -2.703  0.0452
 g2 - g4    -3.247 3.56 48  -0.913  0.7982
 g3 - g4     6.371 3.56 48   1.791  0.2903

N = high:
 contrast estimate   SE df t.ratio p.value
 g1 - g2    -7.668 3.56 48  -2.155  0.1507
 g1 - g3     2.309 3.56 48   0.649  0.9154
 g1 - g4   -14.001 3.56 48  -3.935  0.0015
 g2 - g3     9.977 3.56 48   2.804  0.0353
 g2 - g4    -6.333 3.56 48  -1.780  0.2953
 g3 - g4   -16.310 3.56 48  -4.584  0.0002

P value adjustment: tukey method for comparing a family of 4 estimates </code></pre>
</div>
</div>
<p>Instead of testing pairwise, we can test against one standard control, e.g.&nbsp;the low nitrogen level,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 contrast   estimate   SE df t.ratio p.value
 med - low      6.24 3.56 48   1.753  0.1557
 high - low    20.35 3.56 48   5.721  &lt;.0001

geno = g2:
 contrast   estimate   SE df t.ratio p.value
 med - low      7.37 3.56 48   2.071  0.0816
 high - low    31.28 3.56 48   8.792  &lt;.0001

geno = g3:
 contrast   estimate   SE df t.ratio p.value
 med - low     12.30 3.56 48   3.458  0.0023
 high - low    16.62 3.56 48   4.672  &lt;.0001

geno = g4:
 contrast   estimate   SE df t.ratio p.value
 med - low      8.27 3.56 48   2.323  0.0463
 high - low    35.26 3.56 48   9.912  &lt;.0001

P value adjustment: dunnettx method for 2 tests </code></pre>
</div>
</div>
<p>or the high nitrogen level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>, <span class="at">ref=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 contrast   estimate   SE df t.ratio p.value
 low - high   -20.35 3.56 48  -5.721  &lt;.0001
 med - high   -14.11 3.56 48  -3.967  0.0005

geno = g2:
 contrast   estimate   SE df t.ratio p.value
 low - high   -31.28 3.56 48  -8.792  &lt;.0001
 med - high   -23.91 3.56 48  -6.721  &lt;.0001

geno = g3:
 contrast   estimate   SE df t.ratio p.value
 low - high   -16.62 3.56 48  -4.672  &lt;.0001
 med - high    -4.32 3.56 48  -1.214  0.3841

geno = g4:
 contrast   estimate   SE df t.ratio p.value
 low - high   -35.26 3.56 48  -9.912  &lt;.0001
 med - high   -27.00 3.56 48  -7.589  &lt;.0001

P value adjustment: dunnettx method for 2 tests </code></pre>
</div>
</div>
<p>The <em>compact letter display</em> can be used to indicate or visualise group differences in an easily understandable way. For this we need the <code>library(multcompView)</code> and <code>library(multcomp)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cld</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N    emmean   SE df lower.CL upper.CL .group
 low    62.5 2.52 48     56.3     68.7  a    
 med    68.7 2.52 48     62.5     75.0  a    
 high   82.8 2.52 48     76.6     89.1   b   

geno = g2:
 N    emmean   SE df lower.CL upper.CL .group
 low    59.2 2.52 48     53.0     65.5  a    
 med    66.6 2.52 48     60.4     72.8  a    
 high   90.5 2.52 48     84.3     96.7   b   

geno = g3:
 N    emmean   SE df lower.CL upper.CL .group
 low    63.9 2.52 48     57.7     70.1  a    
 med    76.2 2.52 48     70.0     82.4   b   
 high   80.5 2.52 48     74.3     86.8   b   

geno = g4:
 N    emmean   SE df lower.CL upper.CL .group
 low    61.6 2.52 48     55.4     67.8  a    
 med    69.8 2.52 48     63.6     76.1  a    
 high   96.8 2.52 48     90.6    103.1   b   

Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
P value adjustment: sidak method for 3 tests 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<p>Groups that do not share a letter are significantly different according to the posthoc test, which is corrected for multiple testing using the Sidak method. (former Tukey)</p>
</section>
<section id="presentation-of-results" class="level3">
<h3 class="anchored" data-anchor-id="presentation-of-results">Presentation of results</h3>
<p>We calculate the confidence intervals and perform posthoc tests for each genotype.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>CIs<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>CIs<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CIs<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>CIs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N    emmean   SE df lower.CL upper.CL .group
 low    62.5 2.52 48     56.3     68.7 a     
 med    68.7 2.52 48     62.5     75.0 a     
 high   82.8 2.52 48     76.6     89.1 b     

geno = g2:
 N    emmean   SE df lower.CL upper.CL .group
 low    59.2 2.52 48     53.0     65.5 a     
 med    66.6 2.52 48     60.4     72.8 a     
 high   90.5 2.52 48     84.3     96.7 b     

geno = g3:
 N    emmean   SE df lower.CL upper.CL .group
 low    63.9 2.52 48     57.7     70.1 a     
 med    76.2 2.52 48     70.0     82.4 b     
 high   80.5 2.52 48     74.3     86.8 b     

geno = g4:
 N    emmean   SE df lower.CL upper.CL .group
 low    61.6 2.52 48     55.4     67.8 a     
 med    69.8 2.52 48     63.6     76.1 a     
 high   96.8 2.52 48     90.6    103.1 b     

Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
P value adjustment: sidak method for 3 tests 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<p>And plot the data together with estimated marginal means and confidence intervals and mention that the letters display differences between nitrogen levels for each genotype according to the posthoc test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span><span class="st">"errorbar"</span>, <span class="at">width =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape=</span><span class="cn">NA</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="fl">0.1</span>, <span class="at">jitter.height =</span> <span class="dv">0</span>, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dodge.width=</span><span class="fl">0.6</span>), <span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y=</span>emmean), </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">110</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Dry matter yield (dt/ha)"</span>)<span class="sc">+</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we have 5 observations per treatment level, we can use a boxplot. However, having fewer that 5, it may be better to display just the observations as points, and skip the summary stats that a boxplot displays.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y=</span>emmean), </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">110</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Dry matter yield (dt/ha)"</span>)<span class="sc">+</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="rcbd" class="level1">
<h1>RCBD</h1>
<p>If the data come from a randomized complete block design, we should take the block effect into the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>block<span class="ot">=</span><span class="fu">as.factor</span>(df<span class="sc">$</span>rep)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>N, <span class="at">shape=</span>block)) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)<span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Dry matter yield (dt/ha)"</span>)<span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="linear-model-with-block-as-fixed-effect" class="level2">
<h2 class="anchored" data-anchor-id="linear-model-with-block-as-fixed-effect">Linear model with block as fixed effect</h2>
<p>In addition to the <code>geno * N</code> effects, we fit <code>block</code> as predictor variable in the model. Block should be coded as factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(yield <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, <span class="at">data =</span> df)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = yield ~ geno * N + block, data = df)

Residuals:
   Min     1Q Median     3Q    Max 
-9.670 -2.537  0.149  2.322  7.600 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   58.5065     2.0255  28.885  &lt; 2e-16 ***
genog2        -3.2606     2.4807  -1.314 0.195523    
genog3         1.4225     2.4807   0.573 0.569274    
genog4        -0.9117     2.4807  -0.368 0.714996    
Nmed           6.2378     2.4807   2.515 0.015648 *  
Nhigh         20.3527     2.4807   8.204 2.06e-10 ***
block2         1.5365     1.6013   0.960 0.342530    
block3         7.7468     1.6013   4.838 1.64e-05 ***
block4         1.4096     1.6013   0.880 0.383479    
block5         9.2300     1.6013   5.764 7.49e-07 ***
genog2:Nmed    1.1303     3.5082   0.322 0.748847    
genog3:Nmed    6.0655     3.5082   1.729 0.090834 .  
genog4:Nmed    2.0285     3.5082   0.578 0.566067    
genog2:Nhigh  10.9283     3.5082   3.115 0.003233 ** 
genog3:Nhigh  -3.7315     3.5082  -1.064 0.293296    
genog4:Nhigh  14.9123     3.5082   4.251 0.000109 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.922 on 44 degrees of freedom
Multiple R-squared:  0.9296,    Adjusted R-squared:  0.9057 
F-statistic: 38.76 on 15 and 44 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Response: yield
          Df Sum Sq Mean Sq  F value    Pr(&gt;F)    
geno       3  195.6    65.2   4.2376   0.01025 *  
N          2 6955.4  3477.7 226.0497 &lt; 2.2e-16 ***
block      4  842.0   210.5  13.6828 2.503e-07 ***
geno:N     6  951.5   158.6  10.3080 4.111e-07 ***
Residuals 44  676.9    15.4                       
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Model diagnostics should be extended to plotting residuals against the block.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model2, <span class="at">plot =</span> F)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-23-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-23-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-23-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Posthoc test as before for the N-effect for each genotype.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>CI2s<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model2, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>CI2s<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CI2s<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>CI2s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N    emmean   SE df lower.CL upper.CL .group
 low    62.5 1.75 44     58.1     66.8 a     
 med    68.7 1.75 44     64.4     73.1 b     
 high   82.8 1.75 44     78.5     87.2 c     

geno = g2:
 N    emmean   SE df lower.CL upper.CL .group
 low    59.2 1.75 44     54.9     63.6 a     
 med    66.6 1.75 44     62.2     71.0 b     
 high   90.5 1.75 44     86.2     94.9 c     

geno = g3:
 N    emmean   SE df lower.CL upper.CL .group
 low    63.9 1.75 44     59.6     68.3 a     
 med    76.2 1.75 44     71.9     80.6 b     
 high   80.5 1.75 44     76.2     84.9 b     

geno = g4:
 N    emmean   SE df lower.CL upper.CL .group
 low    61.6 1.75 44     57.2     65.9 a     
 med    69.8 1.75 44     65.5     74.2 b     
 high   96.8 1.75 44     92.5    101.2 c     

Results are averaged over the levels of: block 
Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
P value adjustment: sidak method for 3 tests 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>emmean), </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">110</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Dry matter yield (dt/ha)"</span>)<span class="sc">+</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s compare both models</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>CI.comp<span class="ot">=</span><span class="fu">rbind</span>(CIs, CI2s)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>CI.comp<span class="sc">$</span>model<span class="ot">=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"model"</span>, <span class="st">"model2"</span>), <span class="at">each=</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>CI.comp, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">x=</span>N, <span class="at">col=</span>model, <span class="at">group=</span>model))<span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.4</span>, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno)<span class="sc">+</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The estimated marginal means do not differ, but the width of the confidence interval does. model 2, which takes the block effect into account, has narrower CIs.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>In a complete randomized design (CRD), replication is implicit in the random assignment, so there’s no need to include it explicitly in the model. In an randomized complete block design (RCBD) or any design with a blocking structure, blocking should be included as a factor in the model to account for the additional structure and prevent confounding treatment effects with block-based variability.</p>
</div>
</div>
</section>
<section id="linear-mixed-effect-model-with-block-as-random-effect-glmmtmb" class="level2">
<h2 class="anchored" data-anchor-id="linear-mixed-effect-model-with-block-as-random-effect-glmmtmb">Linear mixed effect model with block as random effect (glmmTMB)</h2>
<p>Block may be also used as random effect:</p>
<ul>
<li><p>when your block represents a random sample from a larger population, e.g.&nbsp;when you test the treatments on multiple fields, and you are not interested in the field (block) effects, i.e.&nbsp;you like to generalize the findings to all fields and not just the ones you used in the study.</p></li>
<li><p>when you have many blocks (&gt;4-8 levels) and you are rather interested in the variance that the block is attributed to (variance partitioning),</p></li>
<li><p>or you have incomplete blocks or repeated measures.</p></li>
</ul>
<p>Here I present examples for mixed effect models using the libraries <code>glmmTMB</code> and <code>lme4</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">glmmTMB</span>(yield <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>block), <span class="at">data =</span> df, <span class="at">REML=</span>T)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian  ( identity )
Formula:          yield ~ geno * N + (1 | block)
Data: df

     AIC      BIC   logLik deviance df.resid 
   325.2    354.5   -148.6    297.2       46 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 block    (Intercept) 16.26    4.032   
 Residual             15.38    3.922   
Number of obs: 60, groups:  block, 5

Dispersion estimate for gaussian family (sigma^2): 15.4 

Conditional model:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   62.4910     2.5157  24.840  &lt; 2e-16 ***
genog2        -3.2606     2.4807  -1.314  0.18871    
genog3         1.4225     2.4807   0.573  0.56635    
genog4        -0.9117     2.4807  -0.368  0.71323    
Nmed           6.2378     2.4807   2.515  0.01192 *  
Nhigh         20.3527     2.4807   8.204 2.32e-16 ***
genog2:Nmed    1.1303     3.5082   0.322  0.74732    
genog3:Nmed    6.0655     3.5082   1.729  0.08382 .  
genog4:Nmed    2.0285     3.5082   0.578  0.56312    
genog2:Nhigh  10.9283     3.5082   3.115  0.00184 ** 
genog3:Nhigh  -3.7315     3.5082  -1.064  0.28749    
genog4:Nhigh  14.9123     3.5082   4.251 2.13e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table (Type II Wald chisquare tests)

Response: yield
         Chisq Df Pr(&gt;Chisq)    
geno    12.713  3   0.005301 ** 
N      452.100  2  &lt; 2.2e-16 ***
geno:N  61.848  6  1.895e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>CI3s<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model3, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>CI3s<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CI3s<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>CI3s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N    emmean   SE df lower.CL upper.CL .group
 low    62.5 2.52 46     56.3     68.7 a     
 med    68.7 2.52 46     62.5     75.0 b     
 high   82.8 2.52 46     76.6     89.1 c     

geno = g2:
 N    emmean   SE df lower.CL upper.CL .group
 low    59.2 2.52 46     53.0     65.5 a     
 med    66.6 2.52 46     60.4     72.8 b     
 high   90.5 2.52 46     84.3     96.7 c     

geno = g3:
 N    emmean   SE df lower.CL upper.CL .group
 low    63.9 2.52 46     57.7     70.1 a     
 med    76.2 2.52 46     70.0     82.5 b     
 high   80.5 2.52 46     74.3     86.8 b     

geno = g4:
 N    emmean   SE df lower.CL upper.CL .group
 low    61.6 2.52 46     55.3     67.8 a     
 med    69.8 2.52 46     63.6     76.1 b     
 high   96.8 2.52 46     90.6    103.1 c     

Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
P value adjustment: sidak method for 3 tests 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CI3s, <span class="fu">aes</span>(<span class="at">y=</span>emmean), </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI3s, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI3s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">110</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Dry matter yield (dt/ha)"</span>)<span class="sc">+</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="linear-mixed-effect-model-with-block-as-random-effect-lme4" class="level2">
<h2 class="anchored" data-anchor-id="linear-mixed-effect-model-with-block-as-random-effect-lme4">Linear mixed effect model with block as random effect (lme4)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(yield <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>block), <span class="at">data =</span> df, <span class="at">REML=</span>T)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: yield ~ geno * N + (1 | block)
   Data: df

REML criterion at convergence: 297.2

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.51098 -0.59464  0.02494  0.68972  1.86338 

Random effects:
 Groups   Name        Variance Std.Dev.
 block    (Intercept) 16.26    4.032   
 Residual             15.38    3.922   
Number of obs: 60, groups:  block, 5

Fixed effects:
             Estimate Std. Error      df t value Pr(&gt;|t|)    
(Intercept)   62.4910     2.5157 12.2943  24.840 7.01e-12 ***
genog2        -3.2606     2.4807 44.0000  -1.314 0.195523    
genog3         1.4225     2.4807 44.0000   0.573 0.569274    
genog4        -0.9117     2.4807 44.0000  -0.368 0.714996    
Nmed           6.2378     2.4807 44.0000   2.515 0.015648 *  
Nhigh         20.3527     2.4807 44.0000   8.204 2.06e-10 ***
genog2:Nmed    1.1303     3.5082 44.0000   0.322 0.748847    
genog3:Nmed    6.0655     3.5082 44.0000   1.729 0.090834 .  
genog4:Nmed    2.0285     3.5082 44.0000   0.578 0.566067    
genog2:Nhigh  10.9283     3.5082 44.0000   3.115 0.003233 ** 
genog3:Nhigh  -3.7315     3.5082 44.0000  -1.064 0.293296    
genog4:Nhigh  14.9123     3.5082 44.0000   4.251 0.000109 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) genog2 genog3 genog4 Nmed   Nhigh  gng2:Nm gng3:Nm gng4:Nm
genog2      -0.493                                                           
genog3      -0.493  0.500                                                    
genog4      -0.493  0.500  0.500                                             
Nmed        -0.493  0.500  0.500  0.500                                      
Nhigh       -0.493  0.500  0.500  0.500  0.500                               
genog2:Nmed  0.349 -0.707 -0.354 -0.354 -0.707 -0.354                        
genog3:Nmed  0.349 -0.354 -0.707 -0.354 -0.707 -0.354  0.500                 
genog4:Nmed  0.349 -0.354 -0.354 -0.707 -0.707 -0.354  0.500   0.500         
genog2:Nhgh  0.349 -0.707 -0.354 -0.354 -0.354 -0.707  0.500   0.250   0.250 
genog3:Nhgh  0.349 -0.354 -0.707 -0.354 -0.354 -0.707  0.250   0.500   0.250 
genog4:Nhgh  0.349 -0.354 -0.354 -0.707 -0.354 -0.707  0.250   0.250   0.500 
            gng2:Nh gng3:Nh
genog2                     
genog3                     
genog4                     
Nmed                       
Nhigh                      
genog2:Nmed                
genog3:Nmed                
genog4:Nmed                
genog2:Nhgh                
genog3:Nhgh  0.500         
genog4:Nhgh  0.500   0.500 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Type III Analysis of Variance Table with Satterthwaite's method
       Sum Sq Mean Sq NumDF DenDF  F value    Pr(&gt;F)    
geno    195.6    65.2     3    44   4.2376   0.01025 *  
N      6955.4  3477.7     2    44 226.0497 &lt; 2.2e-16 ***
geno:N  951.5   158.6     6    44  10.3080 4.111e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>CI4s<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model4, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>CI4s<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CI3s<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>CI4s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N    emmean   SE   df lower.CL upper.CL .group
 low    62.5 2.52 12.3     55.5     69.4 a     
 med    68.7 2.52 12.3     61.8     75.7 b     
 high   82.8 2.52 12.3     75.9     89.8 c     

geno = g2:
 N    emmean   SE   df lower.CL upper.CL .group
 low    59.2 2.52 12.3     52.3     66.2 a     
 med    66.6 2.52 12.3     59.7     73.5 b     
 high   90.5 2.52 12.3     83.6     97.5 c     

geno = g3:
 N    emmean   SE   df lower.CL upper.CL .group
 low    63.9 2.52 12.3     57.0     70.9 a     
 med    76.2 2.52 12.3     69.3     83.2 b     
 high   80.5 2.52 12.3     73.6     87.5 b     

geno = g4:
 N    emmean   SE   df lower.CL upper.CL .group
 low    61.6 2.52 12.3     54.6     68.5 a     
 med    69.8 2.52 12.3     62.9     76.8 b     
 high   96.8 2.52 12.3     89.9    103.8 c     

Degrees-of-freedom method: kenward-roger 
Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
P value adjustment: sidak method for 3 tests 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>yield, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CI4s, <span class="fu">aes</span>(<span class="at">y=</span>emmean), </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI4s, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI4s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">110</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Dry matter yield (dt/ha)"</span>)<span class="sc">+</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="lets-compare-the-models" class="level3">
<h3 class="anchored" data-anchor-id="lets-compare-the-models">Let’s compare the models</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>CI.comp<span class="ot">=</span><span class="fu">rbind</span>(CIs, CI2s, CI3s, CI4s)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>CI.comp<span class="sc">$</span>model<span class="ot">=</span><span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"lm crd"</span>, <span class="st">"lm rcbd"</span>, <span class="st">"glmmTMB"</span>,  <span class="st">"lmer"</span>), <span class="at">each=</span><span class="dv">12</span>), <span class="at">levels =</span><span class="fu">c</span>(<span class="st">"lm crd"</span>, <span class="st">"lm rcbd"</span>, <span class="st">"glmmTMB"</span>,  <span class="st">"lmer"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>CI.comp, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">x=</span>N, <span class="at">col=</span>model, <span class="at">group=</span>model))<span class="sc">+</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.4</span>, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno)<span class="sc">+</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08_2f_LM_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Again, the estimated marginal means do not differ, but the width of the confidence interval does. model2 (<code>lm rcbd</code>), which takes the block as fixed effect into account, has narrower CIs. model3 (<code>glmmTMB</code>) with block as random effect has similar CIs compared to the model without any block affect and model4 (<code>lme4</code>) has the widest CIs (due to df-method Kenward Roger).</p>

<p>:::</p>

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 <p>All content licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>