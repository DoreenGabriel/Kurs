<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Analysis of two-factorial experiments with generalised linear (mixed effect) models – Einführung in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Einführung in R</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/01/01_Allgemeines.html"> 
<span class="menu-text">Allgemeines</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/02/02_DeskriptiveStats.html"> 
<span class="menu-text">Deskriptive Statistik</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/03/03_Graph.html"> 
<span class="menu-text">Grafische Darstellungen</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/04/04_Anova.html"> 
<span class="menu-text">ANOVA</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/05/05_Regression.html"> 
<span class="menu-text">Regression</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/06/06_StatMod.html"> 
<span class="menu-text">Statistische Modellierung</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/07/07_ExpDesign.html"> 
<span class="menu-text">Experimental Design</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Themen/08/08_2f_LM.html"> 
<span class="menu-text">Two-factorial LM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../Themen/09/09_2f_GLM.html" aria-current="page"> 
<span class="menu-text">Two-factorial GLM</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sometimes-we-run-into-problems-with-applying-linear-models-to-data" id="toc-sometimes-we-run-into-problems-with-applying-linear-models-to-data" class="nav-link active" data-scroll-target="#sometimes-we-run-into-problems-with-applying-linear-models-to-data">Sometimes we run into problems with applying linear models to data:</a></li>
  <li><a href="#but-using-a-generalized-linear-model-glm-might-be-a-better-option." id="toc-but-using-a-generalized-linear-model-glm-might-be-a-better-option." class="nav-link" data-scroll-target="#but-using-a-generalized-linear-model-glm-might-be-a-better-option.">But using a <strong>generalized linear model (GLM)</strong> might be a better option.</a></li>
  <li><a href="#typical-distributions-for-glms" id="toc-typical-distributions-for-glms" class="nav-link" data-scroll-target="#typical-distributions-for-glms">Typical distributions for GLMs</a></li>
  <li><a href="#link-function" id="toc-link-function" class="nav-link" data-scroll-target="#link-function">Link function</a></li>
  <li><a href="#generalized-linear-model-for-count-data" id="toc-generalized-linear-model-for-count-data" class="nav-link" data-scroll-target="#generalized-linear-model-for-count-data">Generalized linear model for count data</a></li>
  <li><a href="#generalized-linear-mixed-effect-model-with-block-as-random-effect-glmmtmb" id="toc-generalized-linear-mixed-effect-model-with-block-as-random-effect-glmmtmb" class="nav-link" data-scroll-target="#generalized-linear-mixed-effect-model-with-block-as-random-effect-glmmtmb">Generalized linear mixed effect model with block as random effect (glmmTMB)</a></li>
  <li><a href="#generalized-linear-mixed-effect-model-with-block-as-random-effect-lme4" id="toc-generalized-linear-mixed-effect-model-with-block-as-random-effect-lme4" class="nav-link" data-scroll-target="#generalized-linear-mixed-effect-model-with-block-as-random-effect-lme4">Generalized linear mixed effect model with block as random effect (lme4)</a>
  <ul class="collapse">
  <li><a href="#comparison-of-all-4-models" id="toc-comparison-of-all-4-models" class="nav-link" data-scroll-target="#comparison-of-all-4-models">Comparison of all 4 models</a></li>
  </ul></li>
  <li><a href="#excercise" id="toc-excercise" class="nav-link" data-scroll-target="#excercise">Excercise</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis of two-factorial experiments with generalised linear (mixed effect) models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)<span class="co"># plotting</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)<span class="co"># data management and summary statistics</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)<span class="co"># plotting</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx)<span class="co"># import and export Excel files</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)<span class="co"># factor repordering</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa) <span class="co"># model diagnostics</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans) <span class="co"># posthoc tests</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcomp) <span class="co"># cld</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcompView) <span class="co">#cld</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB) <span class="co"># mixed model</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car) <span class="co"># anova for glmmTMB</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) <span class="co"># lmer and glmer mixed model</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) <span class="co"># test lmer</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(conflicted)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(lmerTest<span class="sc">::</span>lmer)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress summarise info</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use the same data file as before. <a href="https://github.com/DoreenGabriel/Kurs/blob/main/Themen/08/data_YSM.xlsx" target="_blank">data_YSM.xlsx</a> But let’s assume we have measured the number of <code>pests</code> per trap in the experimental plots.</p>
<p>Import data and convert <code>geno</code> and <code>N</code> to factors, levels of N should not be in alphabetical order</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">read.xlsx</span>(<span class="st">"data_YSM.xlsx"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   60 obs. of  7 variables:
 $ rep    : num  1 2 3 4 5 1 2 3 4 5 ...
 $ geno   : chr  "g1" "g1" "g1" "g1" ...
 $ N      : chr  "low" "low" "low" "low" ...
 $ yield  : num  55.9 63 69.5 59.6 64.4 ...
 $ pests  : num  3 0 8 1 4 8 4 6 4 16 ...
 $ pests.A: num  82 91 86 58 45 111 85 107 82 86 ...
 $ pests.B: num  82 91 86 58 45 111 85 107 82 86 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(geno, N), <span class="sc">~</span> <span class="fu">as.factor</span>(.x)),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">N=</span><span class="fu">fct_relevel</span>(N, <span class="st">"low"</span>, <span class="st">"med"</span>, <span class="st">"high"</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">block=</span><span class="fu">as.factor</span>(rep))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   60 obs. of  8 variables:
 $ rep    : num  1 2 3 4 5 1 2 3 4 5 ...
 $ geno   : Factor w/ 4 levels "g1","g2","g3",..: 1 1 1 1 1 2 2 2 2 2 ...
 $ N      : Factor w/ 3 levels "low","med","high": 1 1 1 1 1 1 1 1 1 1 ...
 $ yield  : num  55.9 63 69.5 59.6 64.4 ...
 $ pests  : num  3 0 8 1 4 8 4 6 4 16 ...
 $ pests.A: num  82 91 86 58 45 111 85 107 82 86 ...
 $ pests.B: num  82 91 86 58 45 111 85 107 82 86 ...
 $ block  : Factor w/ 5 levels "1","2","3","4",..: 1 2 3 4 5 1 2 3 4 5 ...</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>geno, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span><span class="st">"errorbar"</span>, <span class="at">width =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape=</span><span class="cn">NA</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="fl">0.1</span>, <span class="at">jitter.height =</span> <span class="dv">0</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dodge.width=</span><span class="fl">0.6</span>), <span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And we fit a linear model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(pests <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, <span class="at">data =</span> df)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = pests ~ geno * N + block, data = df)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.3167 -2.6500  0.4167  2.1625  8.8833 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    2.5167     2.4031   1.047 0.300694    
genog2         4.4000     2.9431   1.495 0.142053    
genog3         8.0000     2.9431   2.718 0.009355 ** 
genog4         3.8000     2.9431   1.291 0.203399    
Nmed          15.6000     2.9431   5.300 3.55e-06 ***
Nhigh         31.4000     2.9431  10.669 8.74e-14 ***
block2        -3.0833     1.8998  -1.623 0.111737    
block3         3.0833     1.8998   1.623 0.111737    
block4        -0.9167     1.8998  -0.483 0.631837    
block5         4.3333     1.8998   2.281 0.027448 *  
genog2:Nmed  -11.6000     4.1622  -2.787 0.007825 ** 
genog3:Nmed   -7.2000     4.1622  -1.730 0.090669 .  
genog4:Nmed   -8.6000     4.1622  -2.066 0.044728 *  
genog2:Nhigh  -1.4000     4.1622  -0.336 0.738200    
genog3:Nhigh -17.6000     4.1622  -4.228 0.000117 ***
genog4:Nhigh   6.6000     4.1622   1.586 0.119973    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.654 on 44 degrees of freedom
Multiple R-squared:  0.9149,    Adjusted R-squared:  0.8859 
F-statistic: 31.54 on 15 and 44 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model, <span class="at">plot =</span> F)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We observe that variance in residuals increases with increasing nitrogen fertilisation. Hence the assumption on variance homogeneity is not met.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model, <span class="sc">~</span>geno<span class="sc">*</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> geno N    emmean   SE df lower.CL upper.CL
 g1   low     3.2 2.08 44   -0.994     7.39
 g2   low     7.6 2.08 44    3.406    11.79
 g3   low    11.2 2.08 44    7.006    15.39
 g4   low     7.0 2.08 44    2.806    11.19
 g1   med    18.8 2.08 44   14.606    22.99
 g2   med    11.6 2.08 44    7.406    15.79
 g3   med    19.6 2.08 44   15.406    23.79
 g4   med    14.0 2.08 44    9.806    18.19
 g1   high   34.6 2.08 44   30.406    38.79
 g2   high   37.6 2.08 44   33.406    41.79
 g3   high   25.0 2.08 44   20.806    29.19
 g4   high   45.0 2.08 44   40.806    49.19

Results are averaged over the levels of: block 
Confidence level used: 0.95 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>CIs<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model, <span class="sc">~</span>N<span class="sc">|</span>geno), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>CIs<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CIs<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Negative confidence interval. But we cannot measure -1 pests per trap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span><span class="st">"errorbar"</span>, <span class="at">width =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape=</span><span class="cn">NA</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="fl">0.1</span>, <span class="at">jitter.height =</span> <span class="dv">0</span>, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dodge.width=</span><span class="fl">0.6</span>), <span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y=</span>emmean), </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y=</span>emmean, <span class="at">ymin=</span>lower.CL, <span class="at">ymax=</span>upper.CL), </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CIs, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Do you think that these confidence interval match the observed data?</p>
<section id="sometimes-we-run-into-problems-with-applying-linear-models-to-data" class="level3">
<h3 class="anchored" data-anchor-id="sometimes-we-run-into-problems-with-applying-linear-models-to-data">Sometimes we run into problems with applying linear models to data:</h3>
<ul>
<li>no homogeneous variances</li>
<li>no approximate normal distribution of residuals</li>
<li>unrealistic predicted values or confidence intervals
<ul>
<li>e.g.&nbsp;negative values in count data (-2 aphids)</li>
<li>proportions above 100% (101% mortality)</li>
</ul></li>
<li>curvature in residuals</li>
</ul>
<p>Sometimes a transformation of the response helps:</p>
<ul>
<li>for count data: log(y) or sqrt(y) or log(y+k)</li>
<li>for proportions logit(y): log(p/(1-p))</li>
</ul>
</section>
<section id="but-using-a-generalized-linear-model-glm-might-be-a-better-option." class="level3">
<h3 class="anchored" data-anchor-id="but-using-a-generalized-linear-model-glm-might-be-a-better-option.">But using a <strong>generalized linear model (GLM)</strong> might be a better option.</h3>
<p>A generalized linear model (GLM) is an extension of the general linear model that allows for the response variable to have a different <strong>distribution</strong> other than the normal distribution. It enables the modeling of various types of data, such as binary, count, and proportion data, by using a <strong>link function</strong> that transforms the <strong>linear combination of predictors</strong> into a suitable scale for the response variable.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that also for linear models, the assumption of the approximate normal distribution of the response is not related to your y with treatment effects, but for y at any given mean. And we check this assumption by looking at the residuals (where the treatment effect is removed).</p>
</div>
</div>
</section>
<section id="typical-distributions-for-glms" class="level3">
<h3 class="anchored" data-anchor-id="typical-distributions-for-glms">Typical distributions for GLMs</h3>
<ul>
<li>Poisson: for count data</li>
<li>Negative binomal: for clustered count data (not strictly exponential family but used in the GLM framework)</li>
<li>Binomial: for binary or proportion data</li>
<li>Gamma: for positive, continuous data</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The distributions can have different shapes.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="link-function" class="level3">
<h3 class="anchored" data-anchor-id="link-function">Link function</h3>
<p>The link function relates the mean of the response variable to the linear predictor. This function is what allows GLMs to accommodate non-normal data. Common link functions include the log function for count data (Poisson GLM, negative binomial) and strictly positive data (Gamma GLM) and the logit, probit and cloglog function for binary or proportion data (binomial GLM) and the inverse link for Gamma GLM.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generalized-linear-model-for-count-data" class="level2">
<h2 class="anchored" data-anchor-id="generalized-linear-model-for-count-data">Generalized linear model for count data</h2>
<p>We use the function <code>glm</code> and specify the distribution with the family-argument <code>poisson</code> for count data. By default poisson GLMs use the log link.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>model2<span class="ot">=</span><span class="fu">glm</span>(pests <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = pests ~ geno * N + block, family = "poisson", data = df)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   1.12766    0.25701   4.388 1.15e-05 ***
genog2        0.86500    0.29802   2.902 0.003702 ** 
genog3        1.25276    0.28347   4.419 9.90e-06 ***
genog4        0.78276    0.30178   2.594 0.009492 ** 
Nmed          1.77071    0.27044   6.547 5.85e-11 ***
Nhigh         2.38070    0.26131   9.111  &lt; 2e-16 ***
block2       -0.17793    0.09833  -1.810 0.070372 .  
block3        0.15100    0.09052   1.668 0.095276 .  
block4       -0.04967    0.09505  -0.523 0.601272    
block5        0.20626    0.08938   2.308 0.021022 *  
genog2:Nmed  -1.34785    0.34161  -3.946 7.96e-05 ***
genog3:Nmed  -1.21109    0.31812  -3.807 0.000141 ***
genog4:Nmed  -1.07756    0.34058  -3.164 0.001557 ** 
genog2:Nhigh -0.78185    0.31609  -2.473 0.013381 *  
genog3:Nhigh -1.57774    0.30682  -5.142 2.71e-07 ***
genog4:Nhigh -0.51995    0.31827  -1.634 0.102327    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 582.631  on 59  degrees of freedom
Residual deviance:  64.435  on 44  degrees of freedom
AIC: 365.46

Number of Fisher Scoring iterations: 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table (Type II tests)

Response: pests
       LR Chisq Df Pr(&gt;Chisq)    
geno       5.78  3  0.1229236    
N        428.38  2  &lt; 2.2e-16 ***
block     22.29  4  0.0001756 ***
geno:N    61.75  6  1.982e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(model2, <span class="at">test=</span><span class="st">"Chi"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Single term deletions

Model:
pests ~ geno * N + block
       Df Deviance    AIC    LRT  Pr(&gt;Chi)    
&lt;none&gt;      64.435 365.46                     
block   4   86.723 379.75 22.288 0.0001756 ***
geno:N  6  126.186 415.21 61.751 1.982e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>In Poisson GLMs we need to look at the dispersion and assess whether the model assumptions are valid. Since the Poisson distribution is defined by a single parameter lamda which represents both the mean and the variance, we expect the ratio of the mean and the variance to be 1. As a quick check you can devide the residual deviance by the degrees of freedom from the model summary above or use the function <code>testDispersion()</code> from the <code>library(DHARMa)</code>.</p>
<p>Hence overdispersion indicated that observed variance is greater than the mean and this can lead to underestimated standard errors, too narrow confidence intervals and invalid p-values.</p>
<p>Overdispersion can occur if</p>
<ul>
<li>the model misses important explanatory variables or</li>
<li>due to presence of outliers, non-linear pattern or zero-inflation.</li>
</ul>
<p>Possible solutions are extending the model by important explanatory variables (however do not overfit), applying quasipoisson or negative binomial GLMs, or fitting a zero-inflation term (in <code>glmmmTM</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model2, <span class="at">plot =</span> F)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 0.84688, p-value = 0.528
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-15-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-15-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-15-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When calculating the estimated marginal means we now can differentiate between the link scale (at which data were modeled) and the response scale, which is the back-transformed original scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model2, <span class="sc">~</span>N<span class="sc">*</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> N    geno emmean     SE  df asymp.LCL asymp.UCL
 low  g1     1.15 0.2500 Inf     0.664      1.64
 med  g1     2.92 0.1030 Inf     2.722      3.13
 high g1     3.53 0.0761 Inf     3.385      3.68
 low  g2     2.02 0.1620 Inf     1.701      2.34
 med  g2     2.44 0.1310 Inf     2.184      2.70
 high g2     3.62 0.0730 Inf     3.474      3.76
 low  g3     2.41 0.1340 Inf     2.144      2.67
 med  g3     2.97 0.1010 Inf     2.768      3.16
 high g3     3.21 0.0895 Inf     3.034      3.38
 low  g4     1.94 0.1690 Inf     1.605      2.27
 med  g4     2.63 0.1200 Inf     2.395      2.86
 high g4     3.80 0.0668 Inf     3.666      3.93

Results are averaged over the levels of: block 
Results are given on the log (not the response) scale. 
Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>For a Poisson model, this means exponentiating the log-transformed values, so the estimated marginal means are presented as predicted counts rather than log counts. We do this by using the argument <code>type="response"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model2, <span class="sc">~</span>N<span class="sc">*</span>geno, <span class="at">type=</span><span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> N    geno  rate    SE  df asymp.LCL asymp.UCL
 low  g1    3.17 0.792 Inf      1.94      5.17
 med  g1   18.62 1.920 Inf     15.21     22.80
 high g1   34.27 2.610 Inf     29.52     39.79
 low  g2    7.53 1.220 Inf      5.48     10.35
 med  g2   11.49 1.510 Inf      8.88     14.86
 high g2   37.24 2.720 Inf     32.27     42.97
 low  g3   11.09 1.480 Inf      8.54     14.42
 med  g3   19.41 1.960 Inf     15.92     23.67
 high g3   24.76 2.220 Inf     20.78     29.51
 low  g4    6.93 1.170 Inf      4.98      9.66
 med  g4   13.87 1.660 Inf     10.97     17.53
 high g4   44.57 2.980 Inf     39.10     50.81

Results are averaged over the levels of: block 
Confidence level used: 0.95 
Intervals are back-transformed from the log scale </code></pre>
</div>
</div>
<p>We can also interpret the ratios of counts in the Poisson GLM. A ratio greater than 1 indicates that the count for one level of N is higher than the count for the other level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(model2, <span class="sc">~</span>N<span class="sc">|</span>geno, <span class="at">type=</span><span class="st">"response"</span>), <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>, <span class="at">infer=</span><span class="fu">c</span>(T,T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 contrast   ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 med / low   5.88 1.590 Inf      3.22     10.71    1   6.547  &lt;.0001
 high / low 10.81 2.830 Inf      6.05     19.32    1   9.111  &lt;.0001

geno = g2:
 contrast   ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 med / low   1.53 0.319 Inf      0.96      2.43    1   2.026  0.0801
 high / low  4.95 0.880 Inf      3.33      7.35    1   8.989  &lt;.0001

geno = g3:
 contrast   ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 med / low   1.75 0.293 Inf      1.21      2.54    1   3.341  0.0017
 high / low  2.23 0.359 Inf      1.56      3.19    1   4.993  &lt;.0001

geno = g4:
 contrast   ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 med / low   2.00 0.414 Inf      1.26      3.17    1   3.348  0.0016
 high / low  6.43 1.170 Inf      4.29      9.63    1  10.241  &lt;.0001

Results are averaged over the levels of: block 
Confidence level used: 0.95 
Conf-level adjustment: dunnettx method for 2 estimates 
Intervals are back-transformed from the log scale 
P value adjustment: dunnettx method for 2 tests 
Tests are performed on the log scale </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>CI2s<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model2, <span class="sc">~</span>N<span class="sc">|</span>geno, <span class="at">type=</span><span class="st">"response"</span>), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>CI2s<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CI2s<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>CI2s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   3.17 0.792 Inf      1.74      5.76 a     
 med  18.62 1.920 Inf     14.55     23.83 b     
 high 34.27 2.610 Inf     28.57     41.10 c     

geno = g2:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   7.53 1.220 Inf      5.11     11.09 a     
 med  11.49 1.510 Inf      8.40     15.72 a     
 high 37.24 2.720 Inf     31.28     44.34 b     

geno = g3:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low  11.09 1.480 Inf      8.06     15.27 a     
 med  19.41 1.960 Inf     15.25     24.71 b     
 high 24.76 2.220 Inf     20.00     30.66 b     

geno = g4:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   6.93 1.170 Inf      4.63     10.38 a     
 med  13.87 1.660 Inf     10.42     18.45 b     
 high 44.57 2.980 Inf     38.00     52.28 c     

Results are averaged over the levels of: block 
Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
Intervals are back-transformed from the log scale 
P value adjustment: sidak method for 3 tests 
Tests are performed on the log scale 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_boxplot</span>(<span class="at">geom =</span><span class="st">"errorbar"</span>, <span class="at">width =</span> <span class="fl">0.6</span>)<span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape=</span><span class="cn">NA</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">jitter.width =</span> <span class="fl">0.1</span>, <span class="at">jitter.height =</span> <span class="dv">0</span>, </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dodge.width=</span><span class="fl">0.6</span>), <span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>rate), </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">ymin=</span>asymp.LCL, <span class="at">ymax=</span>asymp.UCL), </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The confidence intervals reflect nicely the data, in particular the wider spread with increasing mean.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>rate), </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">ymin=</span>asymp.LCL, <span class="at">ymax=</span>asymp.UCL), </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>rate), </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">ymin=</span>asymp.LCL, <span class="at">ymax=</span>asymp.UCL), </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI2s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)<span class="sc">+</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_sqrt</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I prefer to scale the y-axis using square root or logarithmic intervals to better reflect the analysis (e.g., a GLM with a log link). This approach highlights differences in the lower range of values, making smaller effects more visible, while preventing higher values from dominating the presentation.</p>
</section>
<section id="generalized-linear-mixed-effect-model-with-block-as-random-effect-glmmtmb" class="level2">
<h2 class="anchored" data-anchor-id="generalized-linear-mixed-effect-model-with-block-as-random-effect-glmmtmb">Generalized linear mixed effect model with block as random effect (glmmTMB)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">glmmTMB</span>(pests <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>block), <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: poisson  ( log )
Formula:          pests ~ geno * N + (1 | block)
Data: df

     AIC      BIC   logLik deviance df.resid 
   372.0    399.2   -173.0    346.0       47 

Random effects:

Conditional model:
 Groups Name        Variance Std.Dev.
 block  (Intercept) 0.01482  0.1217  
Number of obs: 60, groups:  block, 5

Conditional model:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)    1.1558     0.2559   4.517 6.28e-06 ***
genog2         0.8650     0.2980   2.902 0.003702 ** 
genog3         1.2528     0.2835   4.419 9.90e-06 ***
genog4         0.7828     0.3018   2.594 0.009492 ** 
Nmed           1.7707     0.2704   6.547 5.85e-11 ***
Nhigh          2.3807     0.2613   9.111  &lt; 2e-16 ***
genog2:Nmed   -1.3478     0.3416  -3.946 7.96e-05 ***
genog3:Nmed   -1.2111     0.3181  -3.807 0.000141 ***
genog4:Nmed   -1.0776     0.3406  -3.164 0.001557 ** 
genog2:Nhigh  -0.7818     0.3161  -2.473 0.013381 *  
genog3:Nhigh  -1.5777     0.3068  -5.142 2.71e-07 ***
genog4:Nhigh  -0.5199     0.3183  -1.634 0.102328    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(model3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table (Type II Wald chisquare tests)

Response: pests
          Chisq Df Pr(&gt;Chisq)    
geno     4.7845  3     0.1883    
N      330.8214  2  &lt; 2.2e-16 ***
geno:N  57.6457  6  1.352e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(model3, <span class="at">test=</span><span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Single term deletions

Model:
pests ~ geno * N + (1 | block)
       Df    AIC    LRT  Pr(&gt;Chi)    
&lt;none&gt;    371.95                     
geno:N  6 421.71 61.751 1.982e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>CI3s<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model3, <span class="sc">~</span>N<span class="sc">|</span>geno, <span class="at">type=</span><span class="st">"response"</span>), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>CI3s<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CI3s<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>CI3s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   3.18 0.813 Inf      1.72      5.85 a     
 med  18.66 2.180 Inf     14.12     24.66 b     
 high 34.35 3.210 Inf     27.47     42.95 c     

geno = g2:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   7.54 1.290 Inf      5.01     11.35 a     
 med  11.51 1.640 Inf      8.20     16.17 a     
 high 37.32 3.400 Inf     30.03     46.39 b     

geno = g3:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low  11.12 1.600 Inf      7.88     15.69 a     
 med  19.46 2.230 Inf     14.79     25.59 b     
 high 24.82 2.600 Inf     19.32     31.87 b     

geno = g4:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   6.95 1.230 Inf      4.55     10.62 a     
 med  13.90 1.830 Inf     10.15     19.02 b     
 high 44.67 3.850 Inf     36.36     54.87 c     

Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
Intervals are back-transformed from the log scale 
P value adjustment: sidak method for 3 tests 
Tests are performed on the log scale 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">data=</span>CI3s, <span class="fu">aes</span>(<span class="at">y=</span>rate), </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI3s, <span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">ymin=</span>asymp.LCL, <span class="at">ymax=</span>asymp.UCL), </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI3s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)<span class="sc">+</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_sqrt</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generalized-linear-mixed-effect-model-with-block-as-random-effect-lme4" class="level2">
<h2 class="anchored" data-anchor-id="generalized-linear-mixed-effect-model-with-block-as-random-effect-lme4">Generalized linear mixed effect model with block as random effect (lme4)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">glmer</span>(pests <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>block), <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: poisson  ( log )
Formula: pests ~ geno * N + (1 | block)
   Data: df

     AIC      BIC   logLik deviance df.resid 
   372.0    399.2   -173.0    346.0       47 

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-1.88306 -0.79432  0.06297  0.53184  2.47315 

Random effects:
 Groups Name        Variance Std.Dev.
 block  (Intercept) 0.01483  0.1218  
Number of obs: 60, groups:  block, 5

Fixed effects:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)    1.1555     0.2558   4.518 6.25e-06 ***
genog2         0.8653     0.2979   2.905 0.003673 ** 
genog3         1.2530     0.2833   4.423 9.75e-06 ***
genog4         0.7832     0.3016   2.597 0.009411 ** 
Nmed           1.7709     0.2703   6.552 5.68e-11 ***
Nhigh          2.3810     0.2612   9.117  &lt; 2e-16 ***
genog2:Nmed   -1.3481     0.3414  -3.949 7.86e-05 ***
genog3:Nmed   -1.2113     0.3179  -3.810 0.000139 ***
genog4:Nmed   -1.0780     0.3404  -3.167 0.001540 ** 
genog2:Nhigh  -0.7821     0.3159  -2.476 0.013296 *  
genog3:Nhigh  -1.5780     0.3066  -5.146 2.66e-07 ***
genog4:Nhigh  -0.5204     0.3181  -1.636 0.101820    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) genog2 genog3 genog4 Nmed   Nhigh  gng2:Nm gng3:Nm gng4:Nm
genog2      -0.820                                                           
genog3      -0.862  0.740                                                    
genog4      -0.809  0.695  0.731                                             
Nmed        -0.903  0.776  0.815  0.766                                      
Nhigh       -0.935  0.803  0.844  0.793  0.884                               
genog2:Nmed  0.715 -0.872 -0.645 -0.606 -0.792 -0.700                        
genog3:Nmed  0.768 -0.659 -0.891 -0.651 -0.850 -0.752  0.673                 
genog4:Nmed  0.717 -0.616 -0.647 -0.886 -0.794 -0.702  0.629   0.675         
genog2:Nhgh  0.773 -0.943 -0.698 -0.655 -0.731 -0.827  0.823   0.622   0.581 
genog3:Nhgh  0.796 -0.684 -0.924 -0.675 -0.753 -0.852  0.596   0.823   0.598 
genog4:Nhgh  0.767 -0.659 -0.693 -0.948 -0.726 -0.821  0.575   0.617   0.840 
            gng2:Nh gng3:Nh
genog2                     
genog3                     
genog4                     
Nmed                       
Nhigh                      
genog2:Nmed                
genog3:Nmed                
genog4:Nmed                
genog2:Nhgh                
genog3:Nhgh  0.704         
genog4:Nhgh  0.679   0.699 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(model4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table (Type II Wald chisquare tests)

Response: pests
          Chisq Df Pr(&gt;Chisq)    
geno     4.7916  3     0.1877    
N      331.2410  2  &lt; 2.2e-16 ***
geno:N  57.7201  6  1.306e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(model4, <span class="at">test=</span><span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Single term deletions

Model:
pests ~ geno * N + (1 | block)
       npar    AIC    LRT   Pr(Chi)    
&lt;none&gt;      371.95                     
geno:N    6 421.71 61.751 1.982e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>CI4s<span class="ot">=</span><span class="fu">cld</span>(<span class="fu">emmeans</span>(model4, <span class="sc">~</span>N<span class="sc">|</span>geno, <span class="at">type=</span><span class="st">"response"</span>), <span class="at">method=</span><span class="st">"pairwise"</span>, <span class="at">adjust=</span><span class="st">"sidak"</span>, <span class="at">Letters=</span>letters)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>CI4s<span class="sc">$</span>.group <span class="ot">=</span><span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, CI4s<span class="sc">$</span>.group, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>CI4s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>geno = g1:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   3.18 0.812 Inf      1.72      5.85 a     
 med  18.66 2.180 Inf     14.13     24.65 b     
 high 34.35 3.210 Inf     27.47     42.94 c     

geno = g2:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   7.54 1.290 Inf      5.01     11.35 a     
 med  11.51 1.640 Inf      8.20     16.17 a     
 high 37.32 3.400 Inf     30.03     46.39 b     

geno = g3:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low  11.12 1.600 Inf      7.88     15.69 a     
 med  19.46 2.230 Inf     14.79     25.59 b     
 high 24.82 2.600 Inf     19.33     31.87 b     

geno = g4:
 N     rate    SE  df asymp.LCL asymp.UCL .group
 low   6.95 1.230 Inf      4.55     10.62 a     
 med  13.90 1.830 Inf     10.16     19.02 b     
 high 44.67 3.850 Inf     36.37     54.87 c     

Confidence level used: 0.95 
Conf-level adjustment: sidak method for 3 estimates 
Intervals are back-transformed from the log scale 
P value adjustment: sidak method for 3 tests 
Tests are performed on the log scale 
significance level used: alpha = 0.05 
NOTE: If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same. </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">data=</span>CI4s, <span class="fu">aes</span>(<span class="at">y=</span>rate), </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape=</span><span class="dv">16</span>,  <span class="at">size=</span><span class="dv">2</span>, </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>CI4s, <span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">ymin=</span>asymp.LCL, <span class="at">ymax=</span>asymp.UCL), </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>CI4s, <span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">60</span>, <span class="at">label =</span>.group), <span class="at">col=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)<span class="sc">+</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_sqrt</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">60</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="comparison-of-all-4-models" class="level3">
<h3 class="anchored" data-anchor-id="comparison-of-all-4-models">Comparison of all 4 models</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(CIs)[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>]<span class="ot">&lt;-</span><span class="fu">colnames</span>(CI2s)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>CI.comp<span class="ot">=</span><span class="fu">rbind</span>(CIs, CI2s, CI3s, CI4s)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>CI.comp<span class="sc">$</span>model<span class="ot">=</span><span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"lm"</span>, <span class="st">"glm"</span>, <span class="st">"glmmTMB"</span>,  <span class="st">"glmer"</span>), <span class="at">each=</span><span class="dv">12</span>), <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"lm"</span>, <span class="st">"glm"</span>, <span class="st">"glmmTMB"</span>,  <span class="st">"glmer"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>CI.comp, <span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">x=</span>N, <span class="at">col=</span>model, <span class="at">group=</span>model))<span class="sc">+</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">y=</span>rate, <span class="at">ymin=</span>asymp.LCL, <span class="at">ymax=</span>asymp.UCL), </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">width=</span><span class="fl">0.4</span>, </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>))<span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno)<span class="sc">+</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Confidence intervals of</p>
<ul>
<li>lm negative</li>
<li>lm constant across fitted values (does not represent natural behavior of count data)</li>
<li>glm(m) do not differ much</li>
</ul>
<p>use mixed effect models</p>
<ul>
<li>many blocks and if you are not interested in block effect</li>
<li>interest in predictions without block effect</li>
<li>repeated measurements</li>
<li>incomplete block design</li>
</ul>
</section>
</section>
<section id="excercise" class="level2">
<h2 class="anchored" data-anchor-id="excercise">Excercise</h2>
<p>Fit a model to explain <code>pests.A</code> and perform model diagnostics.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests.A, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>model.A<span class="ot">=</span><span class="fu">glmmTMB</span>(pests.A <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: poisson  ( log )
Formula:          pests.A ~ geno * N + block
Data: df

     AIC      BIC   logLik deviance df.resid 
   583.1    616.6   -275.6    551.1       44 


Conditional model:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   4.31704    0.05744   75.16  &lt; 2e-16 ***
genog2        0.26321    0.06990    3.77 0.000166 ***
genog3        0.30887    0.06922    4.46 8.10e-06 ***
genog4        0.01915    0.07398    0.26 0.795731    
Nmed          0.43986    0.06739    6.53 6.72e-11 ***
Nhigh         0.84295    0.06286   13.41  &lt; 2e-16 ***
block2       -0.09133    0.03765   -2.43 0.015293 *  
block3        0.06989    0.03616    1.93 0.053242 .  
block4       -0.10176    0.03776   -2.70 0.007038 ** 
block5       -0.06139    0.03736   -1.64 0.100394    
genog2:Nmed  -0.52860    0.09479   -5.58 2.45e-08 ***
genog3:Nmed  -0.26365    0.09094   -2.90 0.003744 ** 
genog4:Nmed  -0.07026    0.09552   -0.74 0.462038    
genog2:Nhigh -0.22358    0.08496   -2.63 0.008495 ** 
genog3:Nhigh -0.51113    0.08623   -5.93 3.07e-09 ***
genog4:Nhigh  0.07497    0.08800    0.85 0.394245    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model.A, <span class="at">plot =</span> F)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-31-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 2.5578, p-value &lt; 2.2e-16
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-31-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-31-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-31-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-31-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>model.A<span class="ot">=</span><span class="fu">glmmTMB</span>(pests.A <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"nbinom2"</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: nbinom2  ( log )
Formula:          pests.A ~ geno * N + block
Data: df

     AIC      BIC   logLik deviance df.resid 
   547.9    583.5   -257.0    513.9       43 


Dispersion parameter for nbinom2 family (): 69.8 

Conditional model:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   4.31795    0.08443   51.14  &lt; 2e-16 ***
genog2        0.26287    0.10313    2.55 0.010810 *  
genog3        0.30753    0.10271    2.99 0.002752 ** 
genog4        0.02115    0.10599    0.20 0.841812    
Nmed          0.44156    0.10145    4.35 1.34e-05 ***
Nhigh         0.84539    0.09852    8.58  &lt; 2e-16 ***
block2       -0.08873    0.06250   -1.42 0.155694    
block3        0.07517    0.06152    1.22 0.221738    
block4       -0.12482    0.06256   -2.00 0.046026 *  
block5       -0.05979    0.06226   -0.96 0.336893    
genog2:Nmed  -0.53126    0.14311   -3.71 0.000205 ***
genog3:Nmed  -0.26693    0.14063   -1.90 0.057689 .  
genog4:Nmed  -0.07079    0.14361   -0.49 0.622028    
genog2:Nhigh -0.21968    0.13679   -1.61 0.108287    
genog3:Nhigh -0.50813    0.13765   -3.69 0.000223 ***
genog4:Nhigh  0.07364    0.13874    0.53 0.595589    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model.A, <span class="at">plot =</span> F)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 0.89791, p-value = 0.72
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-32-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-32-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-32-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Fit a model to explain <code>pests.B</code> and perform model diagnostics.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y=</span>pests.B, <span class="at">x=</span>N, <span class="at">col=</span>N)) <span class="sc">+</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape=</span><span class="dv">1</span>, <span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="fu">rgb</span>(<span class="dv">240</span>,<span class="dv">215</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rgb</span>(<span class="dv">190</span>,<span class="dv">210</span>,<span class="dv">35</span>, <span class="at">max =</span> <span class="dv">255</span>), </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rgb</span>(<span class="dv">35</span>,<span class="dv">80</span>,<span class="dv">150</span>, <span class="at">max =</span> <span class="dv">255</span>)                              ),</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"med"</span>, <span class="st">"high"</span>))<span class="sc">+</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>geno, <span class="at">scales=</span><span class="st">"free"</span>, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">geno=</span>label_both))<span class="sc">+</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Number of pests per trap and 48h"</span>)<span class="sc">+</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Nitrogen fertilisation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>model.B<span class="ot">=</span><span class="fu">glmmTMB</span>(pests.B <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"nbinom2"</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.B)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: nbinom2  ( log )
Formula:          pests.B ~ geno * N + block
Data: df

     AIC      BIC   logLik deviance df.resid 
   589.4    625.0   -277.7    555.4       43 


Dispersion parameter for nbinom2 family (): 22.4 

Conditional model:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   4.30165    0.12329   34.89  &lt; 2e-16 ***
genog2        0.26666    0.15099    1.77 0.077371 .  
genog3        0.18550    0.15205    1.22 0.222459    
genog4        0.02580    0.15311    0.17 0.866210    
Nmed          0.44259    0.14981    2.95 0.003134 ** 
Nhigh         0.85157    0.14793    5.76 8.58e-09 ***
block2       -0.02200    0.09566   -0.23 0.818104    
block3        0.07735    0.09497    0.81 0.415397    
block4       -0.12953    0.09551   -1.36 0.175042    
block5       -0.06121    0.09579   -0.64 0.522836    
genog2:Nmed  -0.53444    0.21161   -2.53 0.011549 *  
genog3:Nmed  -0.39042    0.21220   -1.84 0.065784 .  
genog4:Nmed  -0.06973    0.21197   -0.33 0.742202    
genog2:Nhigh -0.22383    0.20740   -1.08 0.280489    
genog3:Nhigh -0.74386    0.21080   -3.53 0.000417 ***
genog4:Nhigh  0.06699    0.20879    0.32 0.748319    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model.B, <span class="at">plot =</span> F)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 0.73908, p-value = 0.168
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-34-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-34-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-34-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-34-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>model.B1<span class="ot">=</span><span class="fu">glmmTMB</span>(pests.B <span class="sc">~</span> geno <span class="sc">*</span> N <span class="sc">+</span> block, </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dispformula=</span><span class="sc">~</span>geno, <span class="at">data =</span> df, <span class="at">family=</span><span class="st">"nbinom2"</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model.B1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: nbinom2  ( log )
Formula:          pests.B ~ geno * N + block
Dispersion:               ~geno
Data: df

     AIC      BIC   logLik deviance df.resid 
   568.2    610.1   -264.1    528.2       40 


Conditional model:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   4.31621    0.09452   45.67  &lt; 2e-16 ***
genog2        0.26437    0.10217    2.59 0.009667 ** 
genog3        0.18128    0.19762    0.92 0.358992    
genog4        0.02155    0.11058    0.19 0.845508    
Nmed          0.44180    0.11649    3.79 0.000149 ***
Nhigh         0.84560    0.11397    7.42 1.18e-13 ***
block2       -0.07315    0.06582   -1.11 0.266459    
block3        0.05245    0.06453    0.81 0.416325    
block4       -0.11103    0.06528   -1.70 0.088952 .  
block5       -0.05801    0.07500   -0.77 0.439288    
genog2:Nmed  -0.53088    0.14169   -3.75 0.000179 ***
genog3:Nmed  -0.38185    0.27739   -1.38 0.168649    
genog4:Nmed  -0.07132    0.15030   -0.47 0.635145    
genog2:Nhigh -0.22298    0.13533   -1.65 0.099432 .  
genog3:Nhigh -0.74073    0.27629   -2.68 0.007341 ** 
genog4:Nhigh  0.07312    0.14568    0.50 0.615705    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Dispersion model:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   3.7929     0.5878   6.453  1.1e-10 ***
genog2        1.4763     1.1278   1.309  0.19054    
genog3       -1.8739     0.7011  -2.673  0.00752 ** 
genog4        0.7112     1.1171   0.637  0.52436    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>simulationOutput <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model.B1, <span class="at">plot =</span> F)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 0.94674, p-value = 0.936
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simulationOutput)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-35-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>geno)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-35-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>N)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-35-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotResiduals</span>(simulationOutput, <span class="at">form =</span> df<span class="sc">$</span>block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09_2f_GLM_files/figure-html/unnamed-chunk-35-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compare models by AICc. The lower the better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">AICctab</span>(model.B, model.B1, <span class="at">base=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         AICc  dAICc df
model.B1 589.8   0.0 20
model.B  603.9  14.1 17</code></pre>
</div>
</div>

</div>
</div>
</div>

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 <p>All content licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>